#!/usr/bin/make -f

# This Makefile is used to build a debian/control file
# for a Debian Pure Blend.
#
# Copyright (C) Andreas Tille <tille@debian.org>
# Copyright (C) Emmanouil Kiagias <e.kiagias@gmail.com> 
#
# License: GPL

# TARGET_DIST is one of stable, sarge, etch, unstable, or any other available
# sources.list file available
#TODO remove, it is not used in the new blends-dev
#TARGET_DIST := $(shell head -1 debian/changelog |awk '{print $$3}'|tr -d ';')
BLEND := $(shell /usr/share/blends-dev/blend-get-names blendname)

VERSION  := $(shell dpkg-parsechangelog -ldebian/changelog | grep Version: | cut -f2 -d' ' | cut -f1 -d- )
DEB_HOST_ARCH := $(shell dpkg-architecture -qDEB_HOST_ARCH)

GENCONTROL := /usr/share/blends-dev/sec-blend-gen-control
TASKSDIFF := /usr/share/blends-dev/tasks_diff
CURRENTPARH := $(shell pwd)

# Verify whether config/control exists, if yes, add it to the depends of debian/control
CONFIGCONTROL := $(shell if [ -d config -a -e config/control ] ; then echo config/control; fi)

#get two latest releases
RELEASES   := $(shell grep '^$(BLEND)' debian/changelog | head -2 | awk '{print $$2}' | tr -d '[(,)]')
LATEST    := $(shell echo "$(RELEASES)" | cut -d ' ' -f1)
PREVIOUS   := $(shell echo $(RELEASES) | cut -d ' ' -f2)

ifneq "$(LATEST)" "$(PREVIOUS)"
	LINEEND   := $(shell lineend=`grep '^$(BLEND)' debian/changelog -n | sed -n 2p | cut -d ':' -f1`; echo "$$lineend - 3" | bc)
	LINESTART  := $(shell linestart=`grep "* start of automatic changelog entry *" debian/changelog -n | head -1 | awk '{print $$1}' | tr -d ':'`; if [ -z "$$linestart" ]; then echo "0"; else echo "$$linestart - 1" | bc; fi)

	ISGREATER := $(shell expr $(LINESTART) \> $(LINEEND))

	ifeq "$(LINESTART)" "0"
		LINESTART := $(LINEEND)
	else ifeq "$(ISGREATER)" "1"
		LINESTART := $(LINEEND)
	endif
endif

all: $(BLEND)-tasks.desc debian/control

debian/control: debian/control.stub debian/changelog tasks/* $(CONFIGCONTROL)
	(export LC_ALL=C;\
	 echo "# This file is autogenerated via "make -f debian/rules dist".  Do not edit!"; \
	 cat debian/control.stub; \
	 test -f config/control && ( cat config/control; echo ) ; \
	$(GENCONTROL) -S -D -c; cat control-sec.temp ) > $@.new && sed -i 's/[ \t]*$$//' $@.new && mv $@.new $@ && rm control-sec.temp

tasksel: $(BLEND)-tasks.desc
$(BLEND)-tasks.desc: tasks/* debian/changelog
	LC_ALL=C $(GENCONTROL) -S -t -q && sed -i 's/[ \t]*$$//' taskdesc-sec.template && mv taskdesc-sec.template $(BLEND)-tasks.desc.template

statusdump: dependency_data/
	$(TASKSDIFF) --status-dump --tasks .  --output dependency_data/$(BLEND)_$(VERSION).json

#update changelog with dependencies changes
changelogentry: debian/changelog statusdump
ifneq "$(LATEST)" "$(PREVIOUS)"
	if [ ! -f dependency_data/$(BLEND)_$(LATEST).json ]; then \
		echo "dependency_data/$(BLEND)_$(LATEST).json does not exist, can not generate changelog dependencies-changes entry"; \
		exit -1; \
	fi
	if [ ! -f dependency_data/$(BLEND)_$(PREVIOUS).json ]; then \
		echo "dependency_data/$(BLEND)_$(PREVIOUS).json does not exist, can not generate changelog dependencies-changes entry"; \
		exit -1; \
	fi

	(sed $(LINESTART)q debian/changelog; \
	 $(TASKSDIFF) --compare $(CURRENTPARH)/dependency_data/$(BLEND)_$(LATEST).json,$(CURRENTPARH)/dependency_data/$(BLEND)_$(PREVIOUS).json | sed 's/^/  /'; \
	 sed -n '$(LINEEND),$$p' debian/changelog; ) > debian/changelog.new && mv debian/changelog.new debian/changelog
else
	echo "It is the first release, skip the changelog entry"
endif

packages.txt:
	$(GENCONTROL) -a $(DEB_HOST_ARCH) > packages.txt.$$$$ && mv packages.txt.$$$$ packages.txt.$(DEB_HOST_ARCH)

avoidpackages.txt:
	$(GENCONTROL) -e > avoidpackages.txt.$$$$ && mv avoidpackages.txt.$$$$ avoidpackages.txt.$(DEB_HOST_ARCH)

by_vote:
	rm -f by_vote
	wget http://developer.skolelinux.no/popcon/by_vote

packages-sorted.txt: packages.txt by_vote
	for pkg in `cat packages.txt` ; do \
		grep " $$pkg " by_vote ; \
	done | LANG=C sort -r -n -k 4 -k 3 > packages-sorted.txt.$(DEB_HOST_ARCH)
usage: packages-sorted.txt

clean: 
	rm -rf tmp
	rm -f tasks/*~
	rm -rf tasksel
	rm -f packages.txt by_vote packages-sorted.txt
	rm -f debian/*-config.postinst debian/*-config.preinst debian/*-config.postrm debian/*-config.prerm

distclean: clean

proper: distclean
	rm -f debian/control
	rm -f $(BLEND)-tasks.desc

dist:
	rm -f $(BLEND)-tasks.desc debian/control dependency_data/$(BLEND)_$(VERSION).json
	make -f debian/rules get-orig-source
